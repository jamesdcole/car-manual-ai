<!DOCTYPE html>
<html>
<head>
  <title>Car Manual AI - PDF.js Test</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs" type="module"></script>
  <style>
    body { font-family: Arial; max-width: 800px; margin: 50px auto; padding: 20px; }
    input, button { padding: 10px; margin: 5px; font-size: 16px; }
    #answer { margin-top: 20px; padding: 20px; border: 1px solid #ccc; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>ðŸ”§ Car Manual AI - PDF.js Test</h1>
  
  <div>
    <input type="file" id="pdfUpload" accept=".pdf" style="width: 300px;">
    <div id="pdfStatus" style="color: green; margin: 10px 0;"></div>
  </div>
  
  <input type="text" id="question" placeholder="Oil capacity page 642? or What's on page 450?" style="width: 400px;">
  <button onclick="askAI()">Ask AI</button>
  
  <div id="answer">Upload PDF and ask a question!</div>

  <script type="module">
    let pdfDoc = null;
    
    // PDF.js worker setup
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.mjs';
    
    document.getElementById('pdfUpload').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (file) {
        document.getElementById('pdfStatus').textContent = 'Loading PDF...';
        pdfDoc = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
        document.getElementById('pdfStatus').textContent = `âœ… PDF loaded: ${pdfDoc.numPages} pages`;
      }
    });
    
    async function extractPageRange(startPage, endPage) {
      const texts = [];
      for (let i = startPage; i <= endPage; i++) {
        const page = await pdfDoc.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(' ');
        texts.push(`=== PAGE ${i} ===\n${pageText}`);
      }
      return texts.join('\n\n');
    }
    
    window.askAI = async () => {
      const question = document.getElementById('question').value;
      const answerDiv = document.getElementById('answer');
      
      if (!pdfDoc) {
        answerDiv.textContent = 'Please upload PDF first!';
        return;
      }
      
      answerDiv.textContent = 'âš¡ Extracting pages...';
      
      // Smart page detection
      let pageNum = 1;
      const pageMatch = question.match(/page\s+(\d+)/i);
      if (pageMatch) {
        pageNum = parseInt(pageMatch[1]);
      }
      
      const manualText = await extractPageRange(
        Math.max(1, pageNum - 2), 
        Math.min(pdfDoc.numPages, pageNum + 2)
      );
      
      // Send to YOUR working Cloud Function
      const response = await fetch('https://us-central1-car-manual-ai-5c053.cloudfunctions.net/ask', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    filename: 'pdfjs-test',
    question: question,
    manualText: manualText.substring(0, 30000)
  })
});
      
      const data = await response.json();
      answerDiv.textContent = data.answer;
    };
  </script>
</body>
</html>
